
##  postgre 
> 기존에 쓰던 SQLite 대신 postgre 사용하여 DB 관리 시작하기

> [postgre 다운로드 link](https://www.postgresql.org/ftp/pgadmin3/pgadmin4/v1.2/macos/)

###  User와 DB 생성
- 리눅스 (superuser 생성 -s) 
`sudo -u postgres createuser -s -P username`
> 배포 후 서버에서 똑같이 유저 생성 

- 맥 (superuser 생성 -s)
```
django createuser -s -P username
Enter password for new role:
Enter it again:
```
##### 유저 삭제
- mac
`dropuser username`
###  db생성  
- mac
`createdb db_name --owner=username`
> ex:  `createdb deploy_ec2 --owner=ync`

### django
#### settings_deploy.json
- allowed\_hosts와 db 설정한다. (db 설정은 settings_local.json 에도 동일하게)

	```json
	  "django": {
	    "allowed_hosts": [
	      "ec2-13-124-56-218.ap-northeast-2.compute.amazonaws.com",
	      ".ap-northeast-2.compute.amazonaws.com",
	      ".yncho.com"
	    ]
	  },
	  "db": {
	    "engine": "django.db.backends.postgresql_psycopg2",
	    "name": "db_name", #  deploy_ec2
	    "user": "myusername", #  ync
	    "password": "mypassword",
	    "host": "localhost",
	    "port": "5432"
	  }
	}
	```
	
#### settings.py
- config를 로컬 테스트용과 배포용으로 나눠줌! 
- settings\_local/deploy.json을 config에 할당해 DATABASE를 새로 설정한다 (기존에 sqlite로 되어있었음)

	```python
	DATABASES = {
	    'default': {
	        'ENGINE': config['db']['engine'],
	        'NAME': config['db']['name'],
	        'USER': config['db']['user'],
	        'PASSWORD': config['db']['password'],
	        'HOST': config['db']['host'],
	        'PORT': config['db']['port'],
	    }
	}
	```
	
#### 현재 로컬과 배포환경 구분
- 항상 켜져있는 디버그 모드를 꺼준다. 
`DEBUG = os.environ.get('MODE') == 'DEBUG'`

- 그리고 디버그 모드일때와 아닐때 서로 다른 설정파일을 가져오도록 settings.py에 설정
```python
config = json.loads(open(os.path.join(CONFIG_DIR, 'settings_local.json' if DEBUG else 'settings_deploy.json')).read())
```

- 로컬에서 실행할때는 MODE='DEBUG'로 실행해준다. `MODE='DEBUG' ./manage.py runserver`
	- *script 로 작성하여 쉽게 실행하자*

- **서버에서 debug mode 로 실행하기 위해서는 서버상에서 settings.py > `DEBUG=True`**
	
#### 새로운 db적용을 위해 migrate
- Error: 
	
	```
	django.core.exceptions.ImproperlyConfigured: Error loading psycopg2 module: No module named 'psycopg2'
	```
- 에러 해결: `pip install psycopg2` 해주고 나서 **migrate** 해준다. 

##### 환경변수
> 스크립트 작성시 환경변수를 고려해야 하는데...

- 환경변수 알아보기: 시스템상에서 돌아가는 환경의 변수들이 있다  
- 이를 확인하기 위해서는  
	- shell 에서 `env` 
	- python 에서 `import os`> `os.environ`
	
###  스크립트 작성 
- `mkdir .scripts` 홈에 만든다. 
- `vi manage`

	```
	# !/usr/local/bin/zsh #  제트쉘 사용, bash기본으로 바꿔도 됨
	MODE='DEBUG' ./manage.py $* #  "*" 여러 인자 받기 (1: 하나의 인자 받기)
	```
	
- 스크립트 실행을 위헤 `chmod 755 manage`
- 그리고 ~/.zshrc에 path(경로)> which zsh : z셀 위치 알려줌
 지정 후 source 적용

	```
	# My scripts
	export SCRIPTS_PATH="/Users/yn_c/.scripts" #  스크립트 dir 경로
	export PATH="$PATH:$SCRIPTS_PATH"
	```

###  이후 서버로 배포 (scp)
-
**코드는 배포서버에서 절대 수정하지 않는다.**

**로컬에서 수정하여 코드 다시 서버로 배포**

- 서버에서 requirements로 psycopg2설치
- postgresql 도 설치

	```
	 sudo apt-get install postgresql postgresql-contrib
	```
	
- 다시, 유저와 db생성

	```
	sudo -u postgres createuser -s -P ync
	sudo -u postgres createdb deploy_ec2 --owner=ync
	```
- migrate!


##  정적 파일 배포 

장고 로컬에서 static 설정 하고 템플릿에 `/static/images/`에 있는 이미지들 띄워줘보기

###  static_root 설정 
```python
STATIC_URL = '/static/'
STATIC_DIR = os.path.join(BASE_DIR, 'static')
```

- manage.py 이용해서 정적파일 모아주기: `manage collectstatic`

###  nginx에 /static 으로 가도록 설정해주기
![선생님_설명사진](/Users/yn_c/notes_wps/image_note/server_diagram.png)

![선생님_설명사진](/Users/yn_c/notes_wps/image_note/nginx_uwsgi_server.png)
![선생님_설명사진](/Users/yn_c/Downloads/Image uploaded from iOS.jpg)

- nginx웹서버는 /static/ url이 올 경우 static 디렉토리로, 그외에는 uWSGI에서 받아간다. 
- url이 /static/일때는 정적파일 디렉토리로 가도록 **/etc/nginx/site-available/app** 에 다음처럼 추가해준다

	```
	location /static/ {
	        alias /srv/app/static_root/;
	        }
	```

- 그 후 `sudo systemctl restart nginx`하고 나면 잘 나온다 

#### member-model-MyUser(AbstractUser)만들고 이미지 필드 추가
- `pip install pillow`
- migrate하고 싶으나 충돌나서 불가함
	- db 삭제
	
		```
		(deploy_ec2) ❯ dropdb deploy_ec2
		(deploy_ec2) ❯ createdb deploy_ec2 --owner=ync
		```
		
- 다시 manage makemigrations and migrate

#### admin page에서 user 사진 업로드 필드 추가
- member > admin.py에 아래와 같이 설정 
- field_set을 UserAdmin에서 복사해 customize

	```python
	from django.contrib import admin
	from django.contrib.auth.admin import UserAdmin
	#  언더바 인식하기 위해서 이거 꼭 import
	from django.utils.translation import ugettext_lazy as _
	from member.models import MyUser
	
	class MyUserAdmin(UserAdmin):
	#  필드셋에서 이미지 프로파일 추가해야 어드인에서 볼 수 있음
	    fieldsets = (
	        (None, {'fields': ('username', 'password', 'img_profile')}),
	        (_('Personal info'), {'fields': ('first_name', 'last_name', 'email')}),
	        (_('Permissions'), {'fields': ('is_active', 'is_staff', 'is_superuser',
	                                       'groups', 'user_permissions')}),
	        (_('Important dates'), {'fields': ('last_login', 'date_joined')}),
	    )
	
	admin.site.register(MyUser)
	
	```
##  MEDIA_ROOT설정
#### settings.py에서 MEDIA_ROOT, MEDIA_URL설정
```
MEDIA_URL = '/media/'
MEDIA_ROOT = os.path.join(ROOT_DIR, 'media')
```

- static\_root 와 같이 ROOT_DIR에 위치하도록 (기존 templates dir, media dir 들 보다 상위)

- 로컬에서 이미지가 뜨는지 관리자 페이지로 가서 테스트

### 서버로 배포 scp
- `pip install -r requirements.txt` (pillow)

-  db 삭제
	- `sudo -u dropdb deploy_ec2`
	- `sudo -u createdb deploy_ec2 --owner=ync`
- migrate
- createsuperuser 

#### admin으로 로그인하여 이미지 업로드 
- **500에러**: 
	-  /srv/app/media 삭제
	- 다시 `mkdir media` >  `chmod 777 media` (권한 설정을 다시 한다 www-data)
	- 프로필 이미지에 업로드한 이미지가 미디어 폴더에 저장될 수 있게 됨

#### 이미지는 업로드 되어 저장됨 하지만 찾아보기가 안됨??
### nginx에 /media/ 위치 설정
-  `sudo vi /etc/nginx/sites-available/app`: location 설정한다

	```
	server {
	    listen 80;
	    server_name localhost ec2-13-124-56-218.ap-northeast-2.compute.amazonaws.com;
	    charset utf-8;
	    client_max_body_size 128M;
	
	
	    location / {
	        uwsgi_pass    unix:///tmp/app.sock;
	        include       uwsgi_params;
	
	        }
	        #### **media 와 static 다 설정****
	    location /static/ {
	        alias /srv/app/static_root/;
	        }
	    location /media/ {
	        alias /srv/app/media/;
	        }
	}
	```
#####  이제 다시 이미지 찾아보면 잘 보임



